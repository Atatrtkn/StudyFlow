{% extends 'base.html' %}

{% block title %}Raporlar - StudyFlow Admin{% endblock %}

{% block extra_css %}
<style>
    .stat-box {
        background: var(--bg-input);
        border-radius: 12px;
        padding: 1.25rem;
        text-align: center;
    }
    .stat-box .number {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-main);
    }
    .stat-box .label {
        color: var(--text-muted);
        font-size: 0.9rem;
    }
    .chart-container {
        position: relative;
        height: 300px;
    }
</style>
{% endblock %}

{% block content %}
<h4 class="mb-4"><i class="bi bi-graph-up me-2"></i>Raporlar ve Analizler</h4>

<div class="row g-3 mb-4">
    <div class="col-6 col-lg-3">
        <div class="stat-box">
            <div class="number text-primary">{{ kullanici_stats.toplam_kullanici }}</div>
            <div class="label">Toplam Kullanıcı</div>
        </div>
    </div>
    <div class="col-6 col-lg-3">
        <div class="stat-box">
            <div class="number text-success">{{ rez_stats.toplam_rezervasyon }}</div>
            <div class="label">Toplam Rezervasyon</div>
        </div>
    </div>
    <div class="col-6 col-lg-3">
        <div class="stat-box">
            <div class="number text-info">{{ oturum_stats.toplam_oturum }}</div>
            <div class="label">Toplam Oturum</div>
        </div>
    </div>
    <div class="col-6 col-lg-3">
        <div class="stat-box">
            <div class="number text-warning">{{ oturum_stats.ort_verimlilik }}/10</div>
            <div class="label">Ort. Verimlilik</div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-lg-8">
        <div class="card h-100">
            <div class="card-header">Son 30 Gün - Günlük Rezervasyonlar</div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="gunlukChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card h-100">
            <div class="card-header">Rezervasyon Durumları</div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="durumChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header">Saat Bazlı Yoğunluk</div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="saatlikChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header">Haftalık Oturum Sayısı</div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="haftalikChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">En Popüler Alanlar (Top 10)</div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Alan</th>
                                <th>Rezervasyon</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for a in alan_popularite %}
                            <tr>
                                <td style="color: var(--text-muted);">{{ loop.index }}</td>
                                <td style="color: var(--text-main);">{{ a.alan_adi }}</td>
                                <td><span class="badge bg-primary">{{ a.rez_sayisi }}</span></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">Özet Bilgiler</div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-6">
                        <div class="p-3" style="background: var(--bg-input); border-radius: 8px;">
                            <div class="small" style="color: var(--text-muted);">Aktif Kullanıcı</div>
                            <div class="fs-4 fw-bold" style="color: var(--text-main);">{{ kullanici_stats.aktif_kullanici }}</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-3" style="background: var(--bg-input); border-radius: 8px;">
                            <div class="small" style="color: var(--text-muted);">Admin Sayısı</div>
                            <div class="fs-4 fw-bold" style="color: var(--text-main);">{{ kullanici_stats.admin_sayisi }}</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-3" style="background: var(--bg-input); border-radius: 8px;">
                            <div class="small" style="color: var(--text-muted);">Aktif Rezervasyon</div>
                            <div class="fs-4 fw-bold text-success">{{ rez_stats.aktif }}</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-3" style="background: var(--bg-input); border-radius: 8px;">
                            <div class="small" style="color: var(--text-muted);">İptal Edilen</div>
                            <div class="fs-4 fw-bold text-danger">{{ rez_stats.iptal }}</div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="p-3" style="background: var(--bg-input); border-radius: 8px;">
                            <div class="small" style="color: var(--text-muted);">Ort. Oturum Süresi</div>
                            <div class="fs-4 fw-bold" style="color: var(--text-main);">{{ oturum_stats.ort_sure_dk }} dakika</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
const textColor = getComputedStyle(document.body).getPropertyValue('--text-main').trim() || '#1e293b';
const gridColor = getComputedStyle(document.body).getPropertyValue('--border-color').trim() || '#e2e8f0';

Chart.defaults.color = textColor;
Chart.defaults.borderColor = gridColor;

new Chart(document.getElementById('gunlukChart'), {
    type: 'line',
    data: {
        labels: [{% for g in gunluk_rez %}'{{ g.tarih.strftime("%d.%m") }}'{% if not loop.last %},{% endif %}{% endfor %}],
        datasets: [{
            label: 'Rezervasyon',
            data: [{% for g in gunluk_rez %}{{ g.sayi }}{% if not loop.last %},{% endif %}{% endfor %}],
            borderColor: '#4f46e5',
            backgroundColor: 'rgba(79, 70, 229, 0.1)',
            fill: true,
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
            y: { beginAtZero: true, grid: { color: gridColor } },
            x: { grid: { display: false } }
        }
    }
});

new Chart(document.getElementById('durumChart'), {
    type: 'doughnut',
    data: {
        labels: ['Aktif', 'İptal', 'Tamamlandı'],
        datasets: [{
            data: [{{ rez_stats.aktif }}, {{ rez_stats.iptal }}, {{ rez_stats.tamamlandi }}],
            backgroundColor: ['#22c55e', '#ef4444', '#3b82f6']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom' } }
    }
});

new Chart(document.getElementById('saatlikChart'), {
    type: 'bar',
    data: {
        labels: [{% for s in saatlik_dagilim %}'{{ "%02d:00"|format(s.saat|int) }}'{% if not loop.last %},{% endif %}{% endfor %}],
        datasets: [{
            label: 'Rezervasyon',
            data: [{% for s in saatlik_dagilim %}{{ s.sayi }}{% if not loop.last %},{% endif %}{% endfor %}],
            backgroundColor: '#8b5cf6'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
            y: { beginAtZero: true, grid: { color: gridColor } },
            x: { grid: { display: false } }
        }
    }
});

new Chart(document.getElementById('haftalikChart'), {
    type: 'bar',
    data: {
        labels: [{% for h in haftalik_oturum %}'{{ h.hafta }}'{% if not loop.last %},{% endif %}{% endfor %}],
        datasets: [{
            label: 'Oturum',
            data: [{% for h in haftalik_oturum %}{{ h.sayi }}{% if not loop.last %},{% endif %}{% endfor %}],
            backgroundColor: '#06b6d4'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
            y: { beginAtZero: true, grid: { color: gridColor } },
            x: { grid: { display: false } }
        }
    }
});
</script>
{% endblock %}
